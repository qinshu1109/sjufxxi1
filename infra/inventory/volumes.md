# å­˜å‚¨å·ä½¿ç”¨æƒ…å†µåˆ†æ

**ç”Ÿæˆæ—¶é—´**: 2025-06-16  
**åˆ†æèŒƒå›´**: sjufxxié¡¹ç›®Difyå­˜å‚¨é…ç½®  
**ç›®çš„**: ä¸ºPodmanè¿ç§»æä¾›å­˜å‚¨ç­–ç•¥

## ğŸ“Š å­˜å‚¨å·æ¦‚è§ˆ

### æ ¸å¿ƒä¸šåŠ¡æ•°æ®å·
| å·å | å®¿ä¸»æœºè·¯å¾„ | å®¹å™¨è·¯å¾„ | ç”¨é€” | å¤§å°ä¼°ç®— | è¿ç§»é£é™© |
|------|------------|----------|------|----------|----------|
| app_storage | ./volumes/app/storage | /app/api/storage | åº”ç”¨æ–‡ä»¶å­˜å‚¨ | 1-10GB | ä¸­ç­‰ |
| db_data | ./volumes/db/data | /var/lib/postgresql/data | PostgreSQLæ•°æ® | 1-50GB | é«˜ |
| redis_data | ./volumes/redis/data | /data | RedisæŒä¹…åŒ– | 100MB-1GB | ä½ |
| weaviate_data | ./volumes/weaviate | /var/lib/weaviate | å‘é‡æ•°æ®åº“ | 1-100GB | é«˜ |

### å¯é€‰å‘é‡å­˜å‚¨å·
| å·å | å®¿ä¸»æœºè·¯å¾„ | å®¹å™¨è·¯å¾„ | ç”¨é€” | å¤§å°ä¼°ç®— | è¿ç§»ç­–ç•¥ |
|------|------------|----------|------|----------|----------|
| qdrant_data | ./volumes/qdrant | /qdrant/storage | Qdrantå‘é‡å­˜å‚¨ | 1-100GB | æŒ‰éœ€è¿ç§» |
| milvus_data | ./volumes/milvus/milvus | /var/lib/milvus | Milvuså‘é‡å­˜å‚¨ | 1-100GB | æŒ‰éœ€è¿ç§» |
| opensearch_data | ./volumes/opensearch/data | /usr/share/opensearch/data | OpenSearchæ•°æ® | 1-100GB | æŒ‰éœ€è¿ç§» |
| chroma_data | ./volumes/chroma | /chroma/chroma | Chromaå‘é‡å­˜å‚¨ | 1-100GB | æŒ‰éœ€è¿ç§» |

### é…ç½®å’Œæ—¥å¿—å·
| å·å | å®¿ä¸»æœºè·¯å¾„ | å®¹å™¨è·¯å¾„ | ç”¨é€” | å¤§å°ä¼°ç®— | è¿ç§»é£é™© |
|------|------------|----------|------|----------|----------|
| nginx_config | ./nginx/ | /etc/nginx/ | Nginxé…ç½® | <10MB | ä½ |
| certbot_conf | ./volumes/certbot/conf | /etc/letsencrypt | SSLè¯ä¹¦ | <100MB | ä½ |
| sandbox_deps | ./volumes/sandbox/dependencies | /dependencies | æ²™ç®±ä¾èµ– | 100MB-1GB | ä¸­ç­‰ |
| plugin_storage | ./volumes/plugin_daemon | /app/storage | æ’ä»¶å­˜å‚¨ | 100MB-1GB | ä¸­ç­‰ |

## ğŸ” å­˜å‚¨è®¿é—®æ¨¡å¼åˆ†æ

### è¯»å†™å¯†é›†å‹
| æœåŠ¡ | å· | è®¿é—®æ¨¡å¼ | I/Oç‰¹å¾ | Podmané€‚é…å»ºè®® |
|------|----|---------|---------|--------------------|
| PostgreSQL | db_data | è¯»å†™å¯†é›† | éšæœºI/O | ä½¿ç”¨é«˜æ€§èƒ½å­˜å‚¨ï¼Œé…ç½®åˆé€‚çš„fsync |
| Weaviate | weaviate_data | è¯»å†™å¯†é›† | å¤§æ–‡ä»¶I/O | ç¡®ä¿å……è¶³çš„ç£ç›˜ç©ºé—´å’ŒI/Oå¸¦å®½ |
| Redis | redis_data | å†™å¯†é›† | é¡ºåºå†™å…¥ | é…ç½®AOFæŒä¹…åŒ–ï¼Œå®šæœŸå¤‡ä»½ |

### è¯»å–å¯†é›†å‹
| æœåŠ¡ | å· | è®¿é—®æ¨¡å¼ | I/Oç‰¹å¾ | Podmané€‚é…å»ºè®® |
|------|----|---------|---------|--------------------|
| Nginx | nginx_config | è¯»å–ä¸ºä¸» | å°æ–‡ä»¶è¯»å– | å¯ä»¥ä½¿ç”¨bind mount |
| App Storage | app_storage | è¯»å–ä¸ºä¸» | æ–‡ä»¶æœåŠ¡ | é…ç½®åˆé€‚çš„ç¼“å­˜ç­–ç•¥ |

### ä½é¢‘è®¿é—®
| æœåŠ¡ | å· | è®¿é—®æ¨¡å¼ | I/Oç‰¹å¾ | Podmané€‚é…å»ºè®® |
|------|----|---------|---------|--------------------|
| Certbot | certbot_conf | ä½é¢‘å†™å…¥ | é…ç½®æ–‡ä»¶ | å¯ä»¥ä½¿ç”¨bind mount |
| Logs | å„ç§æ—¥å¿—å· | å†™å…¥ä¸ºä¸» | æ—¥å¿—è½®è½¬ | é…ç½®logrotate |

## âš ï¸ Rootless Podmanè¿ç§»é£é™©

### é«˜é£é™©é¡¹
1. **æ–‡ä»¶æƒé™æ˜ å°„**
   - é—®é¢˜ï¼šrootlessæ¨¡å¼ä¸‹UID/GIDæ˜ å°„å¤æ‚
   - å½±å“ï¼šæ•°æ®åº“æ–‡ä»¶ã€åº”ç”¨æ–‡ä»¶æƒé™é”™è¯¯
   - è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨`podman unshare`è°ƒæ•´æƒé™

2. **å¤§å®¹é‡å‘é‡æ•°æ®**
   - é—®é¢˜ï¼šå‘é‡æ•°æ®åº“æ–‡ä»¶å¯èƒ½è¾¾åˆ°100GB+
   - å½±å“ï¼šè¿ç§»æ—¶é—´é•¿ï¼Œå­˜å‚¨ç©ºé—´éœ€æ±‚å¤§
   - è§£å†³æ–¹æ¡ˆï¼šåˆ†é˜¶æ®µè¿ç§»ï¼Œä½¿ç”¨rsyncå¢é‡åŒæ­¥

3. **æ•°æ®åº“ä¸€è‡´æ€§**
   - é—®é¢˜ï¼šPostgreSQLæ•°æ®è¿ç§»è¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§
   - å½±å“ï¼šæ•°æ®æŸåæˆ–ä¸¢å¤±
   - è§£å†³æ–¹æ¡ˆï¼šåœæœºè¿ç§»ï¼Œå®Œæ•´å¤‡ä»½éªŒè¯

### ä¸­é£é™©é¡¹
1. **é…ç½®æ–‡ä»¶è·¯å¾„**
   - é—®é¢˜ï¼šç»å¯¹è·¯å¾„åœ¨å®¹å™¨ä¸­å¯èƒ½ä¸åŒ
   - å½±å“ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥
   - è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„æˆ–ç¯å¢ƒå˜é‡

2. **ç½‘ç»œå­˜å‚¨**
   - é—®é¢˜ï¼šå¦‚æœä½¿ç”¨NFSç­‰ç½‘ç»œå­˜å‚¨
   - å½±å“ï¼šæ€§èƒ½ä¸‹é™ï¼Œæƒé™é—®é¢˜
   - è§£å†³æ–¹æ¡ˆï¼šæµ‹è¯•ç½‘ç»œå­˜å‚¨å…¼å®¹æ€§

### ä½é£é™©é¡¹
1. **æ—¥å¿—æ–‡ä»¶**
   - é—®é¢˜ï¼šæ—¥å¿—è½®è½¬é…ç½®
   - å½±å“ï¼šç£ç›˜ç©ºé—´å ç”¨
   - è§£å†³æ–¹æ¡ˆï¼šé…ç½®åˆé€‚çš„æ—¥å¿—ç­–ç•¥

## ğŸ› ï¸ Podmanå­˜å‚¨ç­–ç•¥

### å·ç±»å‹é€‰æ‹©
```yaml
# æ¨èçš„Podmanå·é…ç½®
volumes:
  # æ•°æ®åº“æ•°æ® - ä½¿ç”¨å‘½åå·
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/user/data/postgres
  
  # åº”ç”¨å­˜å‚¨ - ä½¿ç”¨å‘½åå·
  app_storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/user/data/app
  
  # é…ç½®æ–‡ä»¶ - ä½¿ç”¨bind mount
  nginx_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/user/config/nginx
```

### æƒé™é…ç½®
```bash
# rootlessæƒé™é…ç½®è„šæœ¬
#!/bin/bash

# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p ~/data/{postgres,redis,weaviate,app}
mkdir -p ~/config/{nginx,certbot}

# è®¾ç½®æ­£ç¡®çš„æƒé™
podman unshare chown -R 999:999 ~/data/postgres
podman unshare chown -R 999:999 ~/data/redis
podman unshare chown -R 1000:1000 ~/data/app
podman unshare chown -R 1000:1000 ~/data/weaviate
```

### å¤‡ä»½ç­–ç•¥
```bash
# æ•°æ®å¤‡ä»½è„šæœ¬
#!/bin/bash

# PostgreSQLå¤‡ä»½
podman exec postgres pg_dump -U postgres dify > backup/postgres_$(date +%Y%m%d).sql

# Rediså¤‡ä»½
podman exec redis redis-cli BGSAVE
cp ~/data/redis/dump.rdb backup/redis_$(date +%Y%m%d).rdb

# å‘é‡æ•°æ®å¤‡ä»½
tar -czf backup/weaviate_$(date +%Y%m%d).tar.gz ~/data/weaviate/
```

## ğŸ“‹ è¿ç§»æ£€æŸ¥æ¸…å•

### è¿ç§»å‰å‡†å¤‡
- [ ] åœæ­¢æ‰€æœ‰DockeræœåŠ¡
- [ ] åˆ›å»ºå®Œæ•´æ•°æ®å¤‡ä»½
- [ ] éªŒè¯å¤‡ä»½å®Œæ•´æ€§
- [ ] å‡†å¤‡Podmanå­˜å‚¨ç›®å½•
- [ ] é…ç½®rootlessæƒé™æ˜ å°„

### è¿ç§»æ‰§è¡Œ
- [ ] å¤åˆ¶æ•°æ®æ–‡ä»¶åˆ°æ–°ä½ç½®
- [ ] è°ƒæ•´æ–‡ä»¶æƒé™
- [ ] é…ç½®Podmanå·
- [ ] æµ‹è¯•å·æŒ‚è½½
- [ ] éªŒè¯æ•°æ®å®Œæ•´æ€§

### è¿ç§»åéªŒè¯
- [ ] æ£€æŸ¥æ‰€æœ‰æœåŠ¡å¯åŠ¨çŠ¶æ€
- [ ] éªŒè¯æ•°æ®åº“è¿æ¥
- [ ] æµ‹è¯•æ–‡ä»¶è¯»å†™æƒé™
- [ ] æ£€æŸ¥æ—¥å¿—è¾“å‡º
- [ ] è¿è¡ŒåŠŸèƒ½æµ‹è¯•

## ğŸ“Š æ€§èƒ½åŸºå‡†

### å­˜å‚¨æ€§èƒ½è¦æ±‚
| æœåŠ¡ | IOPSè¦æ±‚ | å¸¦å®½è¦æ±‚ | å»¶è¿Ÿè¦æ±‚ |
|------|----------|----------|----------|
| PostgreSQL | 1000+ | 100MB/s | <10ms |
| Redis | 10000+ | 50MB/s | <1ms |
| Weaviate | 500+ | 200MB/s | <50ms |
| App Storage | 100+ | 50MB/s | <100ms |

### ç›‘æ§æŒ‡æ ‡
- ç£ç›˜ä½¿ç”¨ç‡
- I/Oç­‰å¾…æ—¶é—´
- è¯»å†™ååé‡
- æ–‡ä»¶ç³»ç»Ÿé”™è¯¯

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®å·è€ƒè™‘ä½¿ç”¨åŠ å¯†æ–‡ä»¶ç³»ç»Ÿ
2. **è®¿é—®æ§åˆ¶**: é™åˆ¶å·çš„è®¿é—®æƒé™
3. **å¤‡ä»½åŠ å¯†**: å¤‡ä»½æ–‡ä»¶ä½¿ç”¨åŠ å¯†å­˜å‚¨
4. **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰å­˜å‚¨è®¿é—®æ“ä½œ
