<execution>
  <constraint>
    ## 客观技术限制
    - **兼容性约束**：必须保持现有API接口完全兼容
    - **数据完整性**：迁移过程中零数据丢失
    - **服务可用性**：系统停机时间不超过4小时
    - **安全合规**：必须通过企业安全审计
    - **性能基准**：新系统性能不低于现有系统85%
    - **预算限制**：总成本控制在现有运维成本150%以内
    - **时间窗口**：必须在6周内完成全部迁移
  </constraint>

  <rule>
    ## 强制性执行规则
    - **渐进式迁移**：禁止大爆炸式全量切换，必须分阶段验证
    - **回滚准备**：每个阶段都必须有完整的回滚方案和测试
    - **数据备份**：任何数据操作前必须完成全量备份
    - **安全优先**：所有变更必须通过安全评估
    - **文档同步**：架构变更必须同步更新技术文档
    - **团队培训**：新技术栈必须完成团队技能培训
    - **监控覆盖**：新组件必须接入现有监控体系
  </rule>

  <guideline>
    ## 实施指导原则
    - **最小可行产品**：优先实现核心功能，非关键特性可后续迭代
    - **自动化优先**：能自动化的操作绝不手工执行
    - **测试驱动**：先写测试用例，再进行功能开发
    - **持续集成**：每日构建，及时发现集成问题
    - **用户体验**：保持或改善现有用户体验
    - **可观测性**：增强系统的日志、监控和告警能力
    - **技术债务**：在重构过程中清理历史技术债务
  </guideline>

  <process>
    ## 系统重构执行流程

    ### Phase 0: 基线盘点 (T0 + 2天)
    ```
    目标：全面了解现有系统架构和依赖关系
    
    执行步骤：
    1. 服务依赖梳理
       - 绘制现有服务拓扑图
       - 识别所有外部依赖
       - 记录配置参数和环境变量
    
    2. 数据资产盘点
       - 数据库schema导出
       - 数据量统计和增长趋势
       - 备份恢复流程验证
    
    3. 性能基线建立
       - 关键接口响应时间测量
       - 系统资源使用率统计
       - 并发处理能力评估
    
    交付物：
    - services.xlsx (服务清单)
    - architecture-current.md (现有架构文档)
    - performance-baseline.json (性能基线数据)
    ```

    ### Phase 1: 容器运行时迁移 (T0 + 1周)
    ```
    目标：从Docker平滑迁移到Podman rootless
    
    执行步骤：
    1. Podman环境准备
       - 安装rootless Podman
       - 配置用户命名空间
       - 验证基础功能
    
    2. Compose文件转换
       - docker-compose.yml → podman-compose.yml
       - 网络配置适配
       - 卷挂载路径调整
    
    3. 镜像构建迁移
       - Dockerfile兼容性检查
       - 构建脚本更新
       - 镜像仓库配置
    
    4. 服务启动验证
       - 单服务启动测试
       - 服务间通信验证
       - 端口映射确认
    
    验收标准：
    - 所有服务在Podman中正常启动
    - 功能测试100%通过
    - 性能指标在基线95%以上
    ```

    ### Phase 2: DB-GPT AWEL集成 (T0 + 2-3周)
    ```
    目标：集成AI工作流能力，实现Text-to-SQL功能
    
    执行步骤：
    1. DB-GPT环境搭建
       - 拉取DB-GPT代码
       - 配置LLM后端
       - 启动AWEL调度器
    
    2. 数据源适配
       - 配置业务数据库连接
       - Schema元数据提取
       - 权限控制设置
    
    3. 自定义工作流开发
       - nl2sql_pipeline.py开发
       - AST白名单验证器
       - 执行反馈自修正循环
    
    4. 前端集成
       - 聊天界面嵌入
       - API接口适配
       - 用户权限集成
    
    验收标准：
    - Text-to-SQL成功率≥90%
    - 恶意SQL 100%被拦截
    - 前端界面用户体验良好
    ```

    ### Phase 3: 质量安全加强 (穿插执行)
    ```
    目标：建立全面的安全和质量保障体系
    
    执行步骤：
    1. SQL安全机制
       - AST白名单实现
       - 危险操作拦截
       - 执行权限控制
    
    2. 执行反馈循环
       - 错误捕获机制
       - LLM自修正逻辑
       - 重试次数限制
    
    3. 全链路日志
       - 请求追踪ID
       - 关键操作审计
       - 性能指标收集
    
    4. 容器安全
       - rootless配置验证
       - 网络隔离设置
       - 镜像安全扫描
    
    验收标准：
    - 安全扫描0高危漏洞
    - 审计日志完整覆盖
    - 异常处理机制完善
    ```

    ### Phase 4: CI/CD自动化 (T0 + 4-5周)
    ```
    目标：建立完整的自动化构建部署流水线
    
    执行步骤：
    1. 自动化测试
       - 单元测试覆盖率≥80%
       - 集成测试自动化
       - 性能基准测试
    
    2. 构建流水线
       - GitHub Actions配置
       - Podman镜像构建
       - 安全扫描集成
    
    3. 部署自动化
       - 环境配置管理
       - Blue/Green部署
       - 回滚机制验证
    
    4. 监控告警
       - 服务健康检查
       - 性能指标监控
       - 异常告警配置
    
    验收标准：
    - 构建部署全自动化
    - 回滚时间<5分钟
    - 监控覆盖率100%
    ```

    ### Phase 5: 生产发布 (T0 + 6周)
    ```
    目标：安全稳定地发布到生产环境
    
    执行步骤：
    1. 预发布验证
       - 生产数据脱敏测试
       - 压力测试验证
       - 用户验收测试
    
    2. 发布执行
       - 数据库迁移
       - 服务切换
       - DNS切换
    
    3. 发布验证
       - 功能完整性检查
       - 性能指标验证
       - 用户反馈收集
    
    4. 运维交接
       - 运维文档更新
       - 故障处理手册
       - 团队培训完成
    
    验收标准：
    - 所有功能正常运行
    - 性能指标达标
    - 运维团队能独立维护
    ```
  </process>

  <criteria>
    ## 重构成功评价标准

    ### 技术指标
    - ✅ 功能完整性：现有功能100%迁移成功
    - ✅ 性能基准：响应时间不超过原系统115%
    - ✅ 可用性：系统可用性≥99.9%
    - ✅ 安全性：通过企业安全审计
    - ✅ 扩展性：支持水平扩展到10倍负载

    ### 业务指标
    - ✅ 用户体验：用户满意度≥85%
    - ✅ AI能力：Text-to-SQL准确率≥90%
    - ✅ 运维效率：部署时间减少80%
    - ✅ 故障恢复：MTTR<30分钟
    - ✅ 成本控制：总成本在预算范围内

    ### 团队指标
    - ✅ 技能提升：团队掌握新技术栈
    - ✅ 文档完善：技术文档覆盖率100%
    - ✅ 知识转移：关键知识有备份人员
    - ✅ 流程优化：开发效率提升30%
    - ✅ 质量保障：Bug率降低50%
  </criteria>
</execution>
